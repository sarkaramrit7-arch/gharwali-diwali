<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üè† Gharwali Diwali - @Anvi & Amrit</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <!-- Google Fonts - Festive Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FF6B35 0%, #FF9933 25%, #FFD700 50%, #FF6B9D 75%, #C44569 100%);
            background-size: 200% 200%;
            animation: diwaliGradient 15s ease infinite;
            min-height: 100vh;
            padding: 10px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes diwaliGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Prevent text selection for better mobile UX */
        .room, .marker-point, button {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 15px;
                border-radius: 10px;
            }
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            padding: 20px;
        }
        .login-screen.hidden {
            display: none;
        }
        .login-title {
            font-size: 48px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 800;
        }
        .login-subtitle {
            font-family: 'Pacifico', cursive;
            font-size: 24px;
            background: linear-gradient(135deg, #FF6B35, #FF9933, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 40px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(255,107,53,0.2);
            letter-spacing: 1px;
        }
        @media (max-width: 768px) {
            .login-screen {
                min-height: auto;
                padding: 10px;
            }
            .login-title {
                font-size: 32px;
                margin-bottom: 15px;
            }
            .login-subtitle {
                font-size: 16px;
                margin-bottom: 25px;
            }
        }
        .login-form {
            width: 100%;
            max-width: 400px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        @media (max-width: 768px) {
            .form-group {
                margin-bottom: 20px;
            }
            .form-group input {
                padding: 18px 15px;
                font-size: 16px;
                -webkit-appearance: none;
                appearance: none;
            }
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF9933 50%, #FFD700 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255,107,53,0.4);
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,53,0.6);
        }
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        @media (max-width: 768px) {
            .login-btn {
                padding: 18px;
                font-size: 18px;
                touch-action: manipulation;
            }
        }
        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        .info-box h3 {
            color: #1976D2;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .info-box p {
            color: #555;
            font-size: 13px;
            line-height: 1.5;
        }
        @media (max-width: 768px) {
            .info-box {
                padding: 12px;
                margin-top: 15px;
            }
            .info-box h3 {
                font-size: 14px;
                margin-bottom: 6px;
            }
            .info-box p {
                font-size: 12px;
                line-height: 1.4;
            }
        }
        
        /* Game Screen */
        .game-screen {
            display: none;
        }
        .game-screen.active {
            display: block;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .team-name {
            text-align: center;
            font-size: 24px;
            background: linear-gradient(135deg, #FF6B35, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .player-info {
            text-align: center;
            font-size: 16px;
            color: #999;
            margin-bottom: 20px;
        }
        .active-players {
            text-align: center;
            font-size: 14px;
            color: #51cf66;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .timer {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            background: linear-gradient(135deg, #FF6B35, #FF9933, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(255,107,53,0.2);
        }
        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            .team-name {
                font-size: 18px;
                margin-bottom: 8px;
            }
            .player-info {
                font-size: 14px;
                margin-bottom: 15px;
            }
            .active-players {
                font-size: 12px;
                margin-bottom: 15px;
            }
            .subtitle {
                font-size: 14px;
                margin-bottom: 15px;
            }
            .timer {
                font-size: 36px;
                margin: 15px 0;
            }
        }
        .timer.warning {
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .game-over {
            text-align: center;
            font-size: 24px;
            color: #ff6b6b;
            font-weight: bold;
            margin: 20px 0;
            display: none;
        }
        @media (max-width: 768px) {
            .game-over {
                font-size: 20px;
                margin: 15px 0;
            }
        }
        @media (max-width: 480px) {
            .game-over {
                font-size: 18px;
                margin: 12px 0;
            }
        }
        
        /* Surprise Message */
        .surprise-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            display: none;
            max-width: 90%;
        }
        .surprise-message.show {
            display: block;
            animation: surprisePopup 0.6s ease-out forwards;
        }
        @keyframes surprisePopup {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        @media (max-width: 768px) {
            .surprise-message {
                padding: 30px 40px;
                font-size: 24px;
                border-radius: 15px;
            }
        }
        @media (max-width: 480px) {
            .surprise-message {
                padding: 25px 30px;
                font-size: 20px;
                border-radius: 12px;
                max-width: 85%;
            }
        }
        .surprise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1999;
            display: none;
        }
        .surprise-overlay.show {
            display: block;
        }
        
        .floorplan-container {
            position: relative;
            max-width: 1200px;
            margin: 30px auto;
            background: #fff;
            border: 3px solid #999;
            border-radius: 20px;
            padding: 20px;
        }
        .floorplan {
            position: relative;
            width: 100%;
            padding-bottom: 70%;
            background: #f9f9f9;
            border-radius: 15px;
        }
        @media (max-width: 768px) {
            .floorplan-container {
                margin: 15px auto;
                border: 2px solid #999;
                border-radius: 15px;
                padding: 10px;
            }
            .floorplan {
                border-radius: 10px;
                padding-bottom: 85%;
            }
        }
        .room {
            position: absolute;
            border: 2px solid #999;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            color: #aaa;
            font-size: 16px;
            text-align: center;
            padding: 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .room:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: #667eea;
        }
        .room.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .room-progress {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            margin-top: 5px;
        }
        @media (max-width: 768px) {
            .room {
                font-size: 11px;
                padding: 5px;
                border-radius: 15px;
                border-width: 1.5px;
            }
            .room-progress {
                font-size: 9px;
                margin-top: 2px;
            }
        }
        @media (max-width: 480px) {
            .room {
                font-size: 9px;
                padding: 3px;
                border-radius: 12px;
            }
            .room-progress {
                font-size: 8px;
            }
        }
        
        /* Landscape mode optimization for mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 10px;
            }
            h1 {
                font-size: 20px;
                margin-bottom: 5px;
            }
            .team-name, .player-info, .active-players {
                font-size: 12px;
                margin-bottom: 5px;
            }
            .subtitle {
                font-size: 12px;
                margin-bottom: 10px;
            }
            .timer {
                font-size: 28px;
                margin: 10px 0;
            }
            .floorplan-container {
                margin: 10px auto;
            }
            .floorplan {
                padding-bottom: 60%;
            }
        }
        
        /* Top Row */
        .backroom { top: 5%; left: 3%; width: 28%; height: 22%; background: #fff3e0; }
        .family-room { top: 5%; left: 34%; width: 28%; height: 22%; background: #e8f5e9; }
        .kitchen { top: 5%; left: 65%; width: 32%; height: 22%; background: #ffebee; }
        .laundry { top: 30%; left: 3%; width: 18%; height: 15%; background: #e1bee7; }
        .bathroom { top: 48%; left: 3%; width: 18%; height: 18%; background: #e0f2f1; }
        .office { top: 69%; left: 3%; width: 18%; height: 26%; background: #e3f2fd; }
        .coat-closet { top: 30%; left: 24%; width: 16%; height: 15%; background: #fce4ec; }
        .stairs { top: 48%; left: 24%; width: 16%; height: 47%; background: #ffe0b2; }
        .dining-room { top: 30%; left: 43%; width: 54%; height: 25%; background: #f3e5f5; }
        .living-room { top: 58%; left: 43%; width: 54%; height: 37%; background: #fff9c4; }
        
        /* Room Detail Modal */
        .room-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .room-modal.active {
            display: flex;
        }
        .room-detail {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        @media (max-width: 768px) {
            .room-detail {
                width: 95%;
                max-width: 100%;
                max-height: 95vh;
                padding: 20px;
                border-radius: 15px;
            }
        }
        @media (max-width: 480px) {
            .room-detail {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                padding: 15px;
                border-radius: 0;
            }
        }
        .room-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        .room-detail-title {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        @media (max-width: 768px) {
            .room-detail-header {
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .room-detail-title {
                font-size: 24px;
                flex: 1;
            }
        }
        @media (max-width: 480px) {
            .room-detail-title {
                font-size: 20px;
            }
        }
        .close-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .close-btn:hover {
            background: #ee5a52;
            transform: translateY(-2px);
        }
        @media (max-width: 768px) {
            .close-btn {
                padding: 12px 20px;
                font-size: 16px;
                touch-action: manipulation;
            }
        }
        .markers-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        .marker-point {
            aspect-ratio: 1;
            border: 3px solid #666;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 140px;
            padding: 10px;
        }
        .marker-point:hover {
            transform: scale(1.05);
            border-color: #2196F3;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
        }
        .marker-point.marked {
            background: #2196F3;
            border-color: #1976D2;
            color: white;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
        }
        .marker-point.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .marker-counter-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            width: 100%;
        }
        .marker-count-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid white;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
            flex-shrink: 0;
        }
        .marker-count-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }
        .marker-count-btn:active {
            transform: scale(0.9);
        }
        .marker-count-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .marker-count-display {
            font-size: 20px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        .marker-point .marker-main-number {
            font-size: 36px;
            margin-bottom: 0px;
            line-height: 1;
        }
        .marker-point:not(.marked) .marker-main-number {
            color: #999;
            font-size: 48px;
        }
        .marker-point:not(.marked):hover .marker-main-number {
            color: #2196F3;
        }
        @media (max-width: 768px) {
            .markers-grid {
                gap: 15px;
                margin-top: 20px;
            }
            .marker-point {
                border-width: 3px;
                min-height: 100px;
            }
            .marker-point .marker-main-number {
                font-size: 30px;
            }
            .marker-point:not(.marked) .marker-main-number {
                font-size: 40px;
            }
            .marker-count-btn {
                width: 42px;
                height: 42px;
                font-size: 22px;
                border-width: 3px;
            }
            .marker-count-display {
                font-size: 18px;
            }
        }
        @media (max-width: 480px) {
            .markers-grid {
                gap: 12px;
                margin-top: 15px;
            }
            .marker-point {
                border-width: 2.5px;
                min-height: 95px;
            }
            .marker-point .marker-main-number {
                font-size: 26px;
            }
            .marker-point:not(.marked) .marker-main-number {
                font-size: 36px;
            }
            .marker-count-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
                border-width: 3px;
            }
            .marker-count-display {
                font-size: 16px;
            }
        }
        .marker-player {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: #51cf66;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .marker-player {
                font-size: 9px;
                padding: 2px 5px;
                bottom: -6px;
                right: -6px;
            }
        }
        .room-stats {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
        @media (max-width: 768px) {
            .room-stats {
                margin-top: 15px;
                font-size: 16px;
            }
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        @media (max-width: 768px) {
            .controls {
                gap: 8px;
                margin-top: 15px;
            }
            button {
                padding: 14px 20px;
                font-size: 15px;
                flex: 1;
                min-width: 120px;
            }
        }
        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }
        }
        .start-btn {
            background: #51cf66;
            color: white;
        }
        .start-btn:hover:not(:disabled) {
            background: #40c057;
            transform: translateY(-2px);
        }
        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .reset-btn {
            background: #ff6b6b;
            color: white;
        }
        .reset-btn:hover {
            background: #ee5a52;
            transform: translateY(-2px);
        }
        .stats {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
        .instruction {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
            padding: 0 10px;
        }
        @media (max-width: 768px) {
            .stats {
                margin-top: 15px;
                font-size: 16px;
            }
            .instruction {
                font-size: 12px;
                margin-top: 8px;
                line-height: 1.4;
            }
        }
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #51cf66;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 3000;
        }
        .sync-indicator.show {
            opacity: 1;
        }
        @media (max-width: 768px) {
            .sync-indicator {
                bottom: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 11px;
            }
        }
        .connection-status {
            text-align: center;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            font-weight: bold;
        }
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        @media (max-width: 768px) {
            .connection-status {
                padding: 6px;
                margin-bottom: 10px;
                font-size: 11px;
            }
        }
        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 500px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .challenge-card {
            padding: 40px;
            background: #e0e0e0;
            border-radius: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .challenge-card.unlocked {
            background: linear-gradient(135deg, #FF6B35 0%, #FF9933 50%, #FFD700 100%);
            color: white;
            cursor: pointer;
            opacity: 1;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.5);
            animation: diyaGlow 2s ease-in-out infinite;
        }
        @keyframes diyaGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 107, 53, 0.5); }
            50% { box-shadow: 0 8px 30px rgba(255, 215, 0, 0.8); }
        }
        .challenge-card.unlocked:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.8);
        }
        
        /* Challenge Tooltip */
        .challenge-card {
            position: relative;
        }
        .challenge-tooltip {
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.6;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            min-width: 280px;
        }
        .challenge-card:hover .challenge-tooltip {
            opacity: 1;
        }
        .challenge-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }
        .challenge-tooltip strong {
            display: block;
            margin-bottom: 8px;
            color: #FFD700;
            font-size: 14px;
            text-align: center;
        }
        .challenge-tooltip .score-line {
            margin: 3px 0;
            text-align: left;
        }
        .challenge-card-content {
            position: relative;
            z-index: 1;
        }
        @media (max-width: 768px) {
            .challenge-tooltip {
                font-size: 11px;
                padding: 12px;
                min-width: 240px;
            }
            .challenge-card.show-tooltip .challenge-tooltip {
                opacity: 1;
            }
        }
        @media (max-width: 768px) {
            .challenges-grid {
                gap: 15px;
                padding: 0 15px;
            }
            .challenge-card {
                padding: 30px 20px;
                font-size: 16px;
            }
        }
        .leaderboard-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .leaderboard-scroll {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 14px;
        }
        .leaderboard thead {
            background: linear-gradient(135deg, #FF6B35 0%, #FF9933 50%, #FFD700 100%);
            color: white;
        }
        .leaderboard th {
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
        }
        .leaderboard td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard tbody tr:hover {
            background: #f8f9ff;
        }
        .leaderboard tbody tr:first-child {
            background: #fff9e6;
            font-weight: bold;
        }
        .leaderboard tbody tr:first-child:hover {
            background: #fff3cc;
        }
        .leaderboard td:first-child {
            font-weight: bold;
            color: #667eea;
        }
        .leaderboard td:nth-child(2) {
            text-align: left;
            font-weight: 600;
        }
        .leaderboard td:last-child {
            font-weight: bold;
            color: #51cf66;
            font-size: 16px;
        }
        @media (max-width: 768px) {
            .leaderboard-container {
                padding: 0 10px;
            }
            .leaderboard {
                font-size: 12px;
            }
            .leaderboard th {
                padding: 10px 5px;
                font-size: 11px;
            }
            .leaderboard td {
                padding: 10px 5px;
            }
            .leaderboard td:last-child {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Returning User Confirmation Screen -->
        <div class="login-screen hidden" id="confirmScreen">
            <h1 class="login-title">üè† Gharwali Diwali</h1>
            <p class="login-subtitle">@Anvi & Amrit</p>
            <h2 style="text-align: center; color: #667eea; margin: 20px 0;">Welcome Back!</h2>
            <div class="login-form">
                <div class="form-group">
                    <label>Are you sure you are:</label>
                    <p id="confirmPlayerName" style="font-size: 24px; font-weight: bold; color: #667eea; padding: 15px; background: #f0f0f0; border-radius: 8px; text-align: center; margin: 15px 0;"></p>
                </div>
                <div class="form-group">
                    <label>Your Team:</label>
                    <p id="confirmTeamName" style="font-size: 20px; font-weight: bold; color: #51cf66; padding: 12px; background: #f0f0f0; border-radius: 8px; text-align: center;"></p>
                </div>
                <button type="button" class="login-btn" onclick="confirmIdentity()" style="background: #51cf66;">‚úì Yes, Continue</button>
                <button type="button" class="login-btn" onclick="startFresh()" style="background: #ff6b6b; margin-top: 15px;">‚úó No, Start Fresh</button>
            </div>
        </div>

        <!-- Step 1: Name Selection Screen -->
        <div class="login-screen hidden" id="nameScreen">
            <h1 class="login-title">üè† Gharwali Diwali</h1>
            <p class="login-subtitle">@Anvi & Amrit</p>
            <div class="login-form">
                <div class="form-group">
                    <label for="playerName">Select or Enter Your Name</label>
                    <input list="namesList" id="playerName" placeholder="Choose from list or type your name" required>
                    <datalist id="namesList">
                        <option value="Anvi">
                        <option value="Amrit">
                        <option value="Priya">
                        <option value="Rahul">
                        <option value="Neha">
                    </datalist>
                </div>
                <button type="button" class="login-btn" onclick="proceedToPassword()">Continue</button>
                <p class="error-message" id="nameError">Please enter your name!</p>
            </div>
            <div class="info-box">
                <h3>üéÆ Multiplayer Features:</h3>
                <p>‚Ä¢ Real-time collaboration with your team<br>
                ‚Ä¢ Shared timer across all players<br>
                ‚Ä¢ See your teammates' progress live<br>
                ‚Ä¢ Work together to win the challenge!</p>
            </div>
        </div>

        <!-- Step 2: Team Assignment Screen -->
        <div class="login-screen hidden" id="teamScreen">
            <h1 class="login-title">üè† Gharwali Diwali</h1>
            <p class="login-subtitle">@Anvi & Amrit</p>
            <div class="login-form">
                <div class="form-group">
                    <label for="displayNameLabel2">Player Name</label>
                    <p id="displayNameLabel2" style="font-size: 20px; font-weight: bold; color: #667eea; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;"></p>
                </div>
                <div class="form-group">
                    <label for="displayTeamLabel2">Your Team (Auto-assigned based on your name)</label>
                    <p id="displayTeamLabel2" style="font-size: 18px; font-weight: bold; color: #51cf66; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;"></p>
                </div>
                <div class="form-group">
                    <label>üë• Current Team Members</label>
                    <div id="teamMembersList" style="padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 50px;">
                        <p style="color: #999; text-align: center; font-size: 14px;">Loading team members...</p>
                    </div>
                </div>
                <button type="button" class="login-btn" onclick="proceedToChallenges()">Continue</button>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button type="button" class="login-btn" onclick="backToNameFromTeam()" style="background: #999; flex: 1; min-width: 120px;">‚Üê Back</button>
                    <button type="button" class="login-btn" onclick="leaveTeamFromAssignment()" style="background: #ff6b6b; flex: 1; min-width: 120px;">Leave Team</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Challenges Selection Screen -->
        <div class="login-screen hidden" id="challengesScreen">
            <h1 class="login-title">üè† Gharwali Diwali</h1>
            <p class="login-subtitle">@Anvi & Amrit</p>
            <h2 style="text-align: center; color: #667eea; margin: 20px 0;">Fun begins at 18 Oct 2025 evening!</h2>
            
            <!-- Leaderboard -->
            <div class="leaderboard-container">
                <h3 style="text-align: center; color: #667eea; margin-bottom: 15px;">üèÜ Leaderboard</h3>
                <div class="leaderboard-scroll">
                    <table class="leaderboard">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Team Name</th>
                                <th>Ch 1</th>
                                <th>Ch 2</th>
                                <th>Ch 3</th>
                                <th>Ch 4</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <tr>
                                <td>1</td>
                                <td>Phuljhari</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Anaar</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>Charkhi</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>Bullet</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>Rocket</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td>Bam</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Challenges Grid -->
            <div class="challenges-grid">
                <div class="challenge-card" id="challenge1" data-challenge="1">
                    Challenge 1<br>üîí
                </div>
                <div class="challenge-card" id="challenge2" data-challenge="2">
                    Challenge 2<br>üîí
                </div>
                <div class="challenge-card" id="challenge3" data-challenge="3">
                    Challenge 3<br>üîí
                </div>
                <div class="challenge-card" id="challenge4" data-challenge="4">
                    Challenge 4<br>üîí
                </div>
            </div>
            <button type="button" class="login-btn" onclick="backToTeamFromChallenges()" style="background: #999; margin-top: 15px;">‚Üê Back</button>
        </div>

        <!-- Step 4: Password Screen -->
        <div class="login-screen hidden" id="passwordScreen">
            <h1 class="login-title">üè† Gharwali Diwali</h1>
            <p class="login-subtitle">@Anvi & Amrit</p>
            <h2 style="text-align: center; color: #667eea; margin: 20px 0;">Challenge 4</h2>
            
            <!-- House Layout Preview -->
            <div style="max-width: 600px; margin: 20px auto; padding: 0 15px;">
                <h3 style="text-align: center; color: #667eea; margin-bottom: 15px;">üè† House Layout Preview</h3>
                <div class="floorplan-container" style="pointer-events: none; opacity: 0.9;">
                    <div class="floorplan">
                        <div class="room backroom" data-room="backroom">
                            <span>Backroom</span>
                        </div>
                        <div class="room family-room" data-room="family-room">
                            <span>Family Room</span>
                        </div>
                        <div class="room kitchen" data-room="kitchen">
                            <span>Kitchen</span>
                        </div>
                        <div class="room laundry" data-room="laundry">
                            <span>Laundry</span>
                        </div>
                        <div class="room bathroom" data-room="bathroom">
                            <span>Bathroom</span>
                        </div>
                        <div class="room office" data-room="office">
                            <span>Office</span>
                        </div>
                        <div class="room coat-closet" data-room="coat-closet">
                            <span>Coat Closet</span>
                        </div>
                        <div class="room stairs" data-room="stairs">
                            <span>Stairs</span>
                        </div>
                        <div class="room dining-room" data-room="dining-room">
                            <span>Dining Room</span>
                        </div>
                        <div class="room living-room" data-room="living-room">
                            <span>Living room</span>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; color: #999; font-size: 14px; margin-top: 10px;">
                    Count items at different locations in each room!
                </p>
            </div>
            
            <!-- Practice Room Example -->
            <div style="max-width: 500px; margin: 30px auto; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="text-align: center; color: #667eea; margin-bottom: 10px;">üéØ Try It Out!</h3>
                <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 20px;">
                    Click a circle to start counting, then use +/‚àí buttons to adjust
                </p>
                <div class="markers-grid" style="grid-template-columns: repeat(3, 1fr); max-width: 350px; margin: 0 auto;">
                    <div class="marker-point" id="practice1" onclick="adjustPracticeCount(1, 1)">
                        <div class="marker-main-number">‚Ä¢</div>
                    </div>
                    <div class="marker-point" id="practice2" onclick="adjustPracticeCount(2, 1)">
                        <div class="marker-main-number">‚Ä¢</div>
                    </div>
                    <div class="marker-point" id="practice3" onclick="adjustPracticeCount(3, 1)">
                        <div class="marker-main-number">‚Ä¢</div>
                    </div>
                    <div class="marker-point" id="practice4" onclick="adjustPracticeCount(4, 1)">
                        <div class="marker-main-number">‚Ä¢</div>
                    </div>
                    <div class="marker-point" id="practice5" onclick="adjustPracticeCount(5, 1)">
                        <div class="marker-main-number">‚Ä¢</div>
                    </div>
                    <div class="marker-point" id="practice6" onclick="adjustPracticeCount(6, 1)">
                        <div class="marker-main-number">‚Ä¢</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button type="button" onclick="resetPracticeRoom()" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#999'" style="padding: 8px 20px; background: #999; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; transition: all 0.3s ease;">
                        üîÑ Reset Practice
                    </button>
                </div>
                <p style="text-align: center; color: #999; font-size: 12px; margin-top: 10px; font-style: italic;">
                    üí° This is just a preview - your real progress will be saved in the game!
                </p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="password">Enter Password to Start</label>
                    <input type="password" id="password" placeholder="Enter game password" required>
                </div>
                <button type="button" class="login-btn" onclick="startGameLogin()">Start Game</button>
                <p class="error-message" id="passwordError">Incorrect password! Try again.</p>
                <button type="button" class="login-btn" onclick="backToChallengesFromPassword()" style="background: #999; margin-top: 15px;">‚Üê Back</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="connection-status disconnected" id="connectionStatus">
                üî¥ Connecting to server...
            </div>
            
            <h1>üè† Gharwali Diwali</h1>
            <p style="text-align: center; color: #999; font-size: 16px; margin-bottom: 10px;">@Anvi & Amrit</p>
            <div class="team-name" id="displayTeamName"></div>
            <div class="player-info" id="displayPlayerName"></div>
            <div class="active-players" id="activePlayers">üë• Active Players: 1</div>
            <p class="subtitle">Click on any room to count items at each location!</p>
            
            <div class="timer" id="timer">1:00</div>
            <div class="game-over" id="gameOver">üéâ Game Complete!</div>
            
            <div class="floorplan-container">
                <div class="floorplan">
                    <div class="room backroom" data-room="backroom" onclick="openRoom('backroom')">
                        <span>Backroom</span>
                        <span class="room-progress" id="progress-backroom">0/9</span>
                    </div>
                    <div class="room family-room" data-room="family-room" onclick="openRoom('family-room')">
                        <span>Family Room</span>
                        <span class="room-progress" id="progress-family-room">0/9</span>
                    </div>
                    <div class="room kitchen" data-room="kitchen" onclick="openRoom('kitchen')">
                        <span>Kitchen</span>
                        <span class="room-progress" id="progress-kitchen">0/9</span>
                    </div>
                    <div class="room laundry" data-room="laundry" onclick="openRoom('laundry')">
                        <span>Laundry</span>
                        <span class="room-progress" id="progress-laundry">0/9</span>
                    </div>
                    <div class="room bathroom" data-room="bathroom" onclick="openRoom('bathroom')">
                        <span>Bathroom</span>
                        <span class="room-progress" id="progress-bathroom">0/9</span>
                    </div>
                    <div class="room office" data-room="office" onclick="openRoom('office')">
                        <span>Office</span>
                        <span class="room-progress" id="progress-office">0/9</span>
                    </div>
                    <div class="room coat-closet" data-room="coat-closet" onclick="openRoom('coat-closet')">
                        <span>Coat Closet</span>
                        <span class="room-progress" id="progress-coat-closet">0/9</span>
                    </div>
                    <div class="room stairs" data-room="stairs" onclick="openRoom('stairs')">
                        <span>Stairs</span>
                        <span class="room-progress" id="progress-stairs">0/9</span>
                    </div>
                    <div class="room dining-room" data-room="dining-room" onclick="openRoom('dining-room')">
                        <span>Dining Room</span>
                        <span class="room-progress" id="progress-dining-room">0/9</span>
                    </div>
                    <div class="room living-room" data-room="living-room" onclick="openRoom('living-room')">
                        <span>Living room</span>
                        <span class="room-progress" id="progress-living-room">0/9</span>
                    </div>
                </div>
            </div>
            
            <p class="instruction">üí° Click any room to count items ‚Ä¢ Use +/‚àí buttons to adjust counts ‚Ä¢ Timer starts automatically! ‚Ä¢ All team members see changes in real-time!</p>
            
            <div class="stats">
                Total Points Counted: <strong><span id="totalCount">0</span>/90</strong> locations
            </div>
            
            <div class="controls">
                <button class="reset-btn" onclick="backToChallengesFromGame()" style="background: #999;">‚Üê Back to Challenges</button>
            </div>
        </div>
    </div>

    <!-- Surprise Message -->
    <div class="surprise-overlay" id="surpriseOverlay"></div>
    <div class="surprise-message" id="surpriseMessage">
        üéâ PLOT TWIST! üéâ<br>
        You get 30 MORE SECONDS!<br>
        It's not over yet! üòÑ
    </div>

    <!-- Room Detail Modal -->
    <div class="room-modal" id="roomModal">
        <div class="room-detail">
            <div class="room-detail-header">
                <h2 class="room-detail-title" id="modalRoomTitle"></h2>
                <button class="close-btn" onclick="closeRoom()">Close</button>
            </div>
            <div class="markers-grid" id="markersGrid"></div>
            <div class="room-stats">
                Points counted in this room: <strong><span id="roomCount">0</span>/9</strong>
            </div>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">üîÑ Syncing...</div>

    <script>
        /*
        ==========================================
        üîí SECURITY NOTICE
        ==========================================
        
        IMPORTANT: For production, use a JavaScript obfuscator:
        - https://obfuscator.io/ (Online obfuscator)
        - https://www.npmjs.com/package/javascript-obfuscator (CLI tool)
        
        Current protections enabled:
        ‚úÖ Password encoding (Base64)
        ‚úÖ Right-click disabled
        ‚úÖ F12 / DevTools shortcuts blocked
        ‚úÖ View Source (Ctrl+U) blocked
        ‚úÖ DevTools open detection
        ‚úÖ Console warnings
        
        ‚ö†Ô∏è  Note: Client-side security can always be bypassed by
        determined users. For true security, use server-side validation.
        
        ==========================================
        ‚úÖ FIREBASE FULLY CONFIGURED!
        ==========================================
        
        Your Firebase Realtime Database is connected!
        Project: seamadic-house-marker
        Database: https://seamadic-house-marker-default-rtdb.firebaseio.com
        
        üî¥ IMPORTANT: SET DATABASE RULES
        
        Go to Firebase Console and set these rules:
        1. Open: https://console.firebase.google.com
        2. Select: seamadic-house-marker project
        3. Click: Realtime Database ‚Üí Rules tab
        4. Paste this:
        
        {
          "rules": {
            "teams": {
              "$teamId": {
                ".read": true,
                ".write": true
              }
            },
            "scores": {
              ".read": true,
              ".write": true
            },
            "activePlayers": {
              ".read": true,
              ".write": true
            },
            "challengeStatus": {
              ".read": true,
              ".write": true
            },
            "gameSettings": {
              ".read": true,
              ".write": true
            }
          }
        }
        
        5. Click "Publish"
        
        ‚ö†Ô∏è  Without these rules, the database won't work!
        
        ==========================================
        */

        // YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD31MZFmZ17DChruqR7dsaU9-OOJCvnoZM",
            authDomain: "seamadic-house-marker.firebaseapp.com",
            databaseURL: "https://seamadic-house-marker-default-rtdb.firebaseio.com",
            projectId: "seamadic-house-marker",
            storageBucket: "seamadic-house-marker.firebasestorage.app",
            messagingSenderId: "46492760717",
            appId: "1:46492760717:web:51e88589e2d1bcd57c80c4",
            measurementId: "G-RW6Y1G2XX9"
        };

        // Obfuscated password - simple encoding
        const _0x4a2b = ['YW52aQ==']; // Base64 encoded "anvi"
        const CORRECT_PASSWORD = atob(_0x4a2b[0]);
        
        const rooms = [
            'backroom', 'family-room', 'kitchen', 'laundry', 'bathroom',
            'office', 'coat-closet', 'stairs', 'dining-room', 'living-room'
        ];
        
        const roomNames = {
            'backroom': 'Backroom',
            'family-room': 'Family Room',
            'kitchen': 'Kitchen',
            'laundry': 'Laundry',
            'bathroom': 'Bathroom',
            'office': 'Office',
            'coat-closet': 'Coat Closet',
            'stairs': 'Stairs',
            'dining-room': 'Dining Room',
            'living-room': 'Living Room'
        };
        
        let database = null;
        let teamRef = null;
        let markedLocations = {};
        let currentRoom = null;
        let timeRemaining = 120; // Default 2 minutes (can be changed by admin)
        let initialTimerValue = 120; // Store the admin-set timer value
        let timerInterval = null;
        let gameActive = false;
        let teamName = '';
        let playerName = '';
        let playerId = '';
        let bonusAdded = false;
        let isConnected = false;
        
        // Initialize bonus time value with default
        if (!window.bonusTimeValue) {
            window.bonusTimeValue = 30;
        }
        
        // Anti-debugging measures
        (function() {
            // Disable right-click
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            document.addEventListener('keydown', function(e) {
                // F12
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+I (DevTools)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+J (Console)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+U (View Source)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+S (Save)
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // DevTools detection
            let devtoolsOpen = false;
            const threshold = 160;
            
            setInterval(function() {
                if (window.outerWidth - window.innerWidth > threshold || 
                    window.outerHeight - window.innerHeight > threshold) {
                    if (!devtoolsOpen) {
                        devtoolsOpen = true;
                        document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 24px; color: #ff6b6b; text-align: center; padding: 20px;">‚ö†Ô∏è Developer Tools Detected<br>Please close to continue</div>';
                    }
                }
            }, 500);
            
            // Console warning
            console.log('%c‚ö†Ô∏è STOP!', 'color: red; font-size: 50px; font-weight: bold;');
            console.log('%cThis is a browser feature intended for developers. Do not paste any code here.', 'font-size: 18px;');
            console.log('%cAccessing game source code violates the game rules.', 'font-size: 16px; color: red;');
        })();
        
        // Initialize marked locations structure
        rooms.forEach(room => {
            markedLocations[room] = {};
        });
        
        // Import Firebase modules and initialize
        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js').then(appModule => {
            return import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js').then(dbModule => {
                return { appModule, dbModule };
            });
        }).then(({ appModule, dbModule }) => {
            const { initializeApp } = appModule;
            const { getDatabase, ref, set, onValue, update, remove, get } = dbModule;
            
            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                isConnected = true;
                updateConnectionStatus(true);
                console.log('‚úÖ Firebase initialized successfully');
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
                updateConnectionStatus(false);
                if (error.code === 'app/invalid-credential') {
                    alert('Firebase configuration error. Please check your databaseURL.');
                }
            }
            
            // Make database functions globally available
            window.firebaseDB = { ref, set, onValue, update, remove, get };
        }).catch(error => {
            console.error('Failed to load Firebase modules:', error);
            updateConnectionStatus(false);
        });

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = 'üü¢ Connected to server';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = 'üî¥ Disconnected from server';
            }
        }

        function showSyncIndicator(message) {
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }

        // Team names pool for auto-assignment (Diwali firecrackers themed)
        const teamNames = ['Phuljhari', 'Anaar', 'Charkhi', 'Bullet', 'Rocket', 'Bam'];
        const challenges = ['ch1', 'ch2', 'ch3', 'ch4'];
        
        // Load and update leaderboard from Firebase
        function loadLeaderboard() {
            if (!database || !window.firebaseDB) {
                setTimeout(loadLeaderboard, 500);
                return;
            }
            
            const { ref, onValue } = window.firebaseDB;
            const scoresRef = ref(database, 'scores');
            
            onValue(scoresRef, (snapshot) => {
                const scores = snapshot.val() || {};
                updateLeaderboardDisplay(scores);
            });
        }
        
        // Load game settings (timer, bonus time) from Firebase
        function loadGameSettings() {
            if (!database || !window.firebaseDB) {
                setTimeout(loadGameSettings, 500);
                return;
            }
            
            const { ref, onValue } = window.firebaseDB;
            const settingsRef = ref(database, 'gameSettings');
            
            onValue(settingsRef, (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    // Update timer values
                    if (settings.initialTimer !== undefined) {
                        initialTimerValue = settings.initialTimer;
                        console.log('‚è±Ô∏è  Timer updated to:', initialTimerValue, 'seconds');
                    }
                    if (settings.bonusTime !== undefined) {
                        window.bonusTimeValue = settings.bonusTime;
                        console.log('‚è±Ô∏è  Bonus time updated to:', settings.bonusTime, 'seconds');
                    }
                } else {
                    // Set defaults if not configured
                    initialTimerValue = 120;
                    window.bonusTimeValue = 30;
                }
            });
        }
        
        // Load and update challenge unlock status from Firebase
        let challengeListenerActive = false;
        
        function loadChallengeStatus() {
            if (!database || !window.firebaseDB) {
                setTimeout(loadChallengeStatus, 500);
                return;
            }
            
            // Only set up listener once
            if (challengeListenerActive) {
                console.log('üîÑ Challenge listener already active');
                return;
            }
            
            const { ref, onValue } = window.firebaseDB;
            const challengesRef = ref(database, 'challengeStatus');
            
            console.log('üéØ Setting up real-time challenge status listener...');
            
            onValue(challengesRef, (snapshot) => {
                const status = snapshot.val() || {};
                console.log('üîî Challenge status update received:', status);
                updateChallengeCards(status);
            });
            
            challengeListenerActive = true;
        }
        
        function updateChallengeCards(status) {
            // Challenge descriptions with full details
            const challengeInfo = {
                1: {
                    title: 'Memory Challenge',
                    shortDesc: 'Test your memory skills!',
                    tooltip: `<strong>üìã Point System</strong>
                        <div class="score-line">ü•á 1st Place: 100 points</div>
                        <div class="score-line">ü•à 2nd Place: 80 points</div>
                        <div class="score-line">ü•â 3rd Place: 60 points</div>
                        <div class="score-line">4th Place: 40 points</div>
                        <div class="score-line">5th Place: 20 points</div>
                        <div class="score-line">6th Place: 0 points</div>`
                },
                2: {
                    title: "Cliche' Party Games",
                    shortDesc: 'Classic party fun!',
                    tooltip: `<strong>üé≤ Point System</strong>
                        <div class="score-line"><strong>Game 1:</strong></div>
                        <div class="score-line">üèÜ Winner: 30 points</div>
                        <div class="score-line">‚ùå Loser: 0 points</div>
                        <div class="score-line" style="margin-top: 8px;"><strong>Game 2:</strong></div>
                        <div class="score-line">üèÜ Winner: 70 points</div>
                        <div class="score-line">ü•à Runner-up: 35 points</div>
                        <div class="score-line">‚ùå Loser: 0 points</div>`
                },
                3: {
                    title: "It's Trivia Time",
                    shortDesc: 'Test your knowledge!',
                    tooltip: `<strong>üß† Point System</strong>
                        <div class="score-line">ü•á 1st Place: 150 points</div>
                        <div class="score-line">ü•à 2nd Place: 125 points</div>
                        <div class="score-line">ü•â 3rd Place: 100 points</div>
                        <div class="score-line">4th Place: 75 points</div>
                        <div class="score-line">5th Place: 50 points</div>
                        <div class="score-line">6th Place: 0 points</div>`
                },
                4: {
                    title: 'House Marker',
                    shortDesc: 'Count items in each room!',
                    tooltip: `<strong>üè† Point System</strong>
                        <div class="score-line">ü•á 1st Place: 150 points</div>
                        <div class="score-line">ü•à 2nd Place: 125 points</div>
                        <div class="score-line">ü•â 3rd Place: 100 points</div>
                        <div class="score-line">4th Place: 75 points</div>
                        <div class="score-line">5th Place: 50 points</div>
                        <div class="score-line">6th Place: 0 points</div>`
                }
            };
            
            // Update each challenge card based on unlock status
            for (let i = 1; i <= 4; i++) {
                const card = document.getElementById(`challenge${i}`);
                if (!card) continue; // Skip if card doesn't exist yet
                
                const isUnlocked = status[`ch${i}`] === true;
                const info = challengeInfo[i];
                
                if (isUnlocked) {
                    card.classList.add('unlocked');
                    card.innerHTML = `
                        <div class="challenge-tooltip">${info.tooltip}</div>
                        <div class="challenge-card-content">
                            <strong>${info.title}</strong><br>
                            <small style="font-size: 12px; opacity: 0.9;">${info.shortDesc}</small><br>
                            ‚ú® UNLOCKED<br>
                            <small style="font-size: 10px; opacity: 0.7; margin-top: 5px; display: block;">üí° Hover for details</small>
                        </div>
                    `;
                    console.log(`‚úÖ Challenge ${i} unlocked`);
                    
                    // Add mobile tap support for tooltips
                    card.addEventListener('touchstart', function(e) {
                        // Toggle tooltip on tap for mobile
                        if (window.innerWidth <= 768) {
                            // Remove show-tooltip from all other cards
                            document.querySelectorAll('.challenge-card').forEach(c => {
                                if (c !== card) c.classList.remove('show-tooltip');
                            });
                            card.classList.toggle('show-tooltip');
                            
                            // If Challenge 4, don't prevent navigation
                            if (i !== 4) {
                                e.stopPropagation();
                            }
                        }
                    });
                    
                    // Only Challenge 4 is playable (house marker game)
                    if (i === 4) {
                        card.onclick = () => selectChallenge4();
                        card.style.cursor = 'pointer';
                    } else {
                        // Other challenges are not interactive yet
                        card.onclick = null;
                        card.style.cursor = 'default';
                    }
                } else {
                    card.classList.remove('unlocked');
                    card.innerHTML = `Challenge ${i}<br>üîí`;
                    card.onclick = null;
                    console.log(`üîí Challenge ${i} locked`);
                }
            }
        }
        
        function updateLeaderboardDisplay(scores) {
            const tbody = document.getElementById('leaderboardBody');
            
            // Calculate totals and sort
            const teamsData = teamNames.map(team => {
                const teamScores = scores[team] || {};
                const ch1 = parseInt(teamScores.ch1) || 0;
                const ch2 = parseInt(teamScores.ch2) || 0;
                const ch3 = parseInt(teamScores.ch3) || 0;
                const ch4 = parseInt(teamScores.ch4) || 0;
                const total = ch1 + ch2 + ch3 + ch4;
                
                return {
                    name: team,
                    ch1: ch1,
                    ch2: ch2,
                    ch3: ch3,
                    ch4: ch4,
                    total: total
                };
            });
            
            // Sort by total (descending)
            teamsData.sort((a, b) => b.total - a.total);
            
            // Update table
            tbody.innerHTML = teamsData.map((team, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${team.name}</td>
                    <td>${team.ch1 > 0 ? team.ch1 : '-'}</td>
                    <td>${team.ch2 > 0 ? team.ch2 : '-'}</td>
                    <td>${team.ch3 > 0 ? team.ch3 : '-'}</td>
                    <td>${team.ch4 > 0 ? team.ch4 : '-'}</td>
                    <td>${team.total}</td>
                </tr>
            `).join('');
        }
        
        // Close tooltips when clicking outside (mobile)
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.challenge-card')) {
                document.querySelectorAll('.challenge-card').forEach(c => {
                    c.classList.remove('show-tooltip');
                });
            }
        });
        
        // Check if user has previous session on page load
        window.addEventListener('load', function() {
            const savedPlayerName = sessionStorage.getItem('playerName');
            const savedTeamName = sessionStorage.getItem('teamName');
            const savedPlayerId = sessionStorage.getItem('playerId');
            
            if (savedPlayerName && savedTeamName && savedPlayerId) {
                // Show confirmation screen instead of auto-filling
                document.getElementById('confirmPlayerName').textContent = savedPlayerName;
                document.getElementById('confirmTeamName').textContent = savedTeamName;
                document.getElementById('confirmScreen').classList.remove('hidden');
                document.getElementById('nameScreen').classList.add('hidden');
            } else {
                // New user - show name screen
                document.getElementById('nameScreen').classList.remove('hidden');
            }
            
            // Load leaderboard from Firebase
            loadLeaderboard();
            
            // Load challenge unlock status from Firebase
            loadChallengeStatus();
            
            // Load game settings (timer) from Firebase
            loadGameSettings();
        });
        
        function confirmIdentity() {
            // User confirmed their identity - go directly to challenges
            const savedPlayerName = sessionStorage.getItem('playerName');
            const savedTeamName = sessionStorage.getItem('teamName');
            const savedPlayerId = sessionStorage.getItem('playerId');
            
            playerName = savedPlayerName;
            teamName = savedTeamName;
            playerId = savedPlayerId;
            
            // Go to challenges screen
            document.getElementById('confirmScreen').classList.add('hidden');
            document.getElementById('challengesScreen').classList.remove('hidden');
            
            // Load challenge status when entering challenges screen
            loadChallengeStatus();
        }
        
        function startFresh() {
            // User wants to start fresh - clear storage and show name screen
            sessionStorage.clear();
            document.getElementById('confirmScreen').classList.add('hidden');
            document.getElementById('nameScreen').classList.remove('hidden');
        }
        
        async function loadTeamMembers() {
            // Load and display all current team members
            const teamMembersList = document.getElementById('teamMembersList');
            
            // Wait for Firebase to be ready
            let retries = 0;
            while ((!database || !window.firebaseDB) && retries < 20) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            if (!database || !window.firebaseDB) {
                teamMembersList.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">You are the first member! üéâ</p>';
                return;
            }
            
            try {
                const { ref, get } = window.firebaseDB;
                const activePlayersRef = ref(database, 'activePlayers');
                const snapshot = await get(activePlayersRef);
                const members = [];
                
                if (snapshot.exists()) {
                    const activePlayers = snapshot.val();
                    // Get all players from the same team
                    for (let pid in activePlayers) {
                        if (activePlayers[pid].team === teamName && activePlayers[pid].isActive) {
                            members.push(activePlayers[pid].name);
                        }
                    }
                }
                
                // Display team members
                if (members.length === 0) {
                    teamMembersList.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">You are the first member! üéâ</p>';
                } else {
                    const membersHTML = members.map(name => 
                        `<div style="display: inline-block; padding: 8px 15px; margin: 5px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 14px; font-weight: 500;">
                            ${name === playerName ? 'üë§ ' + name + ' (You)' : 'üë• ' + name}
                        </div>`
                    ).join('');
                    teamMembersList.innerHTML = `<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;">${membersHTML}</div>`;
                }
            } catch (error) {
                console.error('Error loading team members:', error);
                // Show as first member instead of error
                teamMembersList.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">You are the first member! üéâ</p>';
            }
        }
        
        async function proceedToPassword() {
            const enteredPlayerName = document.getElementById('playerName').value.trim();
            const nameError = document.getElementById('nameError');
            const continueBtn = document.querySelector('#nameScreen .login-btn');
            
            if (!enteredPlayerName) {
                nameError.textContent = 'Please enter your name!';
                nameError.classList.add('show');
                return;
            }
            
            // Show loading state
            const originalBtnText = continueBtn.textContent;
            continueBtn.disabled = true;
            continueBtn.textContent = 'Checking availability...';
            nameError.classList.remove('show');
            playerName = enteredPlayerName;
            
            // Check if this player name is already in use
            const isAvailable = await checkPlayerNameAvailability(playerName);
            
            // Reset button state
            continueBtn.disabled = false;
            continueBtn.textContent = originalBtnText;
            
            if (!isAvailable) {
                nameError.textContent = `"${playerName}" is already logged in! Please choose a different name.`;
                nameError.classList.add('show');
                document.getElementById('playerName').value = '';
                return;
            }
            
            // Auto-assign team based on hash of player name for consistency (consistent hashing)
            const hash = playerName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const teamIndex = hash % teamNames.length;
            teamName = teamNames[teamIndex];
            
            // Generate player ID immediately
            playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Store in sessionStorage
            sessionStorage.setItem('playerName', playerName);
            sessionStorage.setItem('teamName', teamName);
            sessionStorage.setItem('playerId', playerId);
            
            // Register player as active in Firebase immediately
            // Wait a moment for Firebase to be fully ready
            setTimeout(() => {
                if (database && window.firebaseDB) {
                    const { ref, set } = window.firebaseDB;
                    const playerActiveRef = ref(database, `activePlayers/${playerId}`);
                    set(playerActiveRef, {
                        name: playerName,
                        team: teamName,
                        isActive: true,
                        loginTime: Date.now()
                    }).then(() => {
                        console.log('‚úÖ Player registered in Firebase:', playerName, 'Team:', teamName, 'ID:', playerId);
                    }).catch(error => {
                        console.error('‚ùå Error registering player:', error);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Firebase not ready, player not registered');
                }
            }, 200);

            
            // Show on team assignment screen
            document.getElementById('displayNameLabel2').textContent = playerName;
            document.getElementById('displayTeamLabel2').textContent = teamName;
            
            // Load and display team members
            await loadTeamMembers();
            
            // Switch screens
            document.getElementById('nameScreen').classList.add('hidden');
            document.getElementById('teamScreen').classList.remove('hidden');
        }
        
        function proceedToChallenges() {
            // Switch from team screen to challenges screen
            document.getElementById('teamScreen').classList.add('hidden');
            document.getElementById('challengesScreen').classList.remove('hidden');
            
            // Reload challenge status when entering challenges screen
            loadChallengeStatus();
        }
        
        function backToNameFromTeam() {
            // Go back from team screen to name screen
            document.getElementById('teamScreen').classList.add('hidden');
            document.getElementById('nameScreen').classList.remove('hidden');
        }
        
        function leaveTeamFromAssignment() {
            // User wants to leave team from assignment screen
            if (confirm('Are you sure you want to leave? This will clear your session.')) {
                // Remove from active players if already registered
                if (database && window.firebaseDB && playerId) {
                    const { ref, remove } = window.firebaseDB;
                    const playerActiveRef = ref(database, `activePlayers/${playerId}`);
                    remove(playerActiveRef);
                }
                // Clear sessionStorage
                sessionStorage.clear();
                // Reload page to start fresh
                location.reload();
            }
        }
        
        async function backToTeamFromChallenges() {
            // Go back from challenges screen to team screen
            document.getElementById('challengesScreen').classList.add('hidden');
            
            // Update team info display
            document.getElementById('displayNameLabel2').textContent = playerName;
            document.getElementById('displayTeamLabel2').textContent = teamName;
            
            // Reload team members
            await loadTeamMembers();
            
            document.getElementById('teamScreen').classList.remove('hidden');
        }
        
        function selectChallenge4() {
            // User clicked on Challenge 4 - go to password screen
            document.getElementById('challengesScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
        }
        
        function backToChallengesFromPassword() {
            // Go back from password screen to challenges screen
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('password').value = '';
            document.getElementById('passwordError').classList.remove('show');
            document.getElementById('challengesScreen').classList.remove('hidden');
        }
        
        function backToChallengesFromGame() {
            // Go back from game screen to challenges screen
            if (gameActive && !confirm('Game is in progress! Your progress will be saved. Timer continues for your team. Are you sure you want to go back?')) {
                return;
            }
            
            // Stop the LOCAL timer interval only (Firebase continues for other players)
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Set local game as inactive (but don't update Firebase - let it continue)
            gameActive = false;
            
            // Hide game screen and show challenges
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('challengesScreen').classList.remove('hidden');
            
            console.log('‚è∏Ô∏è Left game - timer continues in Firebase for team');
        }
        
        async function checkPlayerNameAvailability(nameToCheck) {
            // Check if this player name is already logged in
            if (!database || !window.firebaseDB) {
                return true; // Allow if Firebase not ready
            }
            
            const { ref, get } = window.firebaseDB;
            const activePlayersRef = ref(database, 'activePlayers');
            
            try {
                const snapshot = await get(activePlayersRef);
                if (snapshot.exists()) {
                    const activePlayers = snapshot.val();
                    // Check if this name is already in use
                    for (let pid in activePlayers) {
                        if (activePlayers[pid].name === nameToCheck && activePlayers[pid].isActive) {
                            return false; // Name already in use
                        }
                    }
                }
                return true; // Name available
            } catch (error) {
                console.error('Error checking player name:', error);
                return true; // Allow on error
            }
        }
        
        function startGameLogin() {
            const enteredPassword = document.getElementById('password').value;
            const passwordError = document.getElementById('passwordError');
            
            if (!enteredPassword) {
                passwordError.textContent = 'Please enter password!';
                passwordError.classList.add('show');
                return;
            }
            
            if (enteredPassword !== CORRECT_PASSWORD) {
                passwordError.textContent = 'Incorrect password! Try again.';
                passwordError.classList.add('show');
                return;
            }
            
            passwordError.classList.remove('show');
            
            // Player ID already generated in proceedToPassword()
            // Player already registered in activePlayers in proceedToPassword()
            
            // Update game screen
            document.getElementById('displayTeamName').textContent = `Team: ${teamName}`;
            document.getElementById('displayPlayerName').textContent = `Player: ${playerName}`;
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('active');
            
            // Wait for Firebase to be ready, then connect
            const checkFirebase = setInterval(() => {
                if (database) {
                    clearInterval(checkFirebase);
                    connectToTeam();
                    // Check if game is already active, if not start new game
                    checkAndJoinOrStartGame();
                }
            }, 100);
            
            // Timeout after 5 seconds if Firebase doesn't connect
            setTimeout(() => {
                if (!database) {
                    clearInterval(checkFirebase);
                    alert('Unable to connect to database. Please check your internet connection and Firebase setup.');
                    updateConnectionStatus(false);
                }
            }, 5000);
        }

        function checkAndJoinOrStartGame() {
            // Check if there's an active game in Firebase before starting new one
            if (!database || !window.firebaseDB) {
                console.error('Firebase not initialized');
                return;
            }
            
            const { ref, get } = window.firebaseDB;
            const teamId = teamName.toLowerCase().replace(/\s+/g, '-');
            const teamDataRef = ref(database, `teams/${teamId}`);
            
            // Get current game state from Firebase
            get(teamDataRef).then((snapshot) => {
                const data = snapshot.val();
                if (data && data.gameActive) {
                    // Game already active - join it with current state
                    console.log('‚úÖ Joining existing game with time:', data.timeRemaining, 'seconds');
                    
                    // Immediately sync all game state from Firebase
                    timeRemaining = data.timeRemaining || 60;
                    bonusAdded = data.bonusAdded || false;
                    gameActive = true;
                    
                    // Sync markers
                    if (data.markers) {
                        markedLocations = data.markers;
                        updateAllRoomProgress();
                        updateTotalCount();
                    }
                    
                    // Update display
                    updateTimerDisplay();
                    document.getElementById('gameOver').style.display = 'none';
                    document.querySelectorAll('.room').forEach(room => {
                        room.classList.remove('disabled');
                    });
                    
                    // Start the timer interval if not already running
                    if (!timerInterval) {
                        timerInterval = setInterval(updateTimer, 1000);
                    }
                    
                    console.log('‚è±Ô∏è Synced to current game time:', timeRemaining, 'seconds');
                } else {
                    // No active game - start new one
                    console.log('üéÆ Starting new game...');
                    setTimeout(() => {
                        startGame();
                    }, 500);
                }
            }).catch((error) => {
                console.error('Error checking game state:', error);
                // On error, try to start game anyway
                setTimeout(() => {
                    startGame();
                }, 500);
            });
        }

        function connectToTeam() {
            if (!database || !window.firebaseDB) {
                console.error('Firebase not initialized');
                return;
            }
            
            const { ref, set, onValue, remove } = window.firebaseDB;
            const teamId = teamName.toLowerCase().replace(/\s+/g, '-');
            teamRef = ref(database, `teams/${teamId}`);
            
            // Listen for changes
            onValue(teamRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Update markers
                    if (data.markers) {
                        markedLocations = data.markers;
                        updateAllRoomProgress();
                        updateTotalCount();
                    }
                    
                    // Update timer
                    if (data.timeRemaining !== undefined) {
                        timeRemaining = data.timeRemaining;
                        updateTimerDisplay();
                    }
                    
                    // Update bonus added state
                    if (data.bonusAdded !== undefined) {
                        bonusAdded = data.bonusAdded;
                    }
                    
                    // Update game state
                    if (data.gameActive !== undefined && data.gameActive !== gameActive) {
                        gameActive = data.gameActive;
                        if (gameActive) {
                            document.getElementById('gameOver').style.display = 'none';
                            document.querySelectorAll('.room').forEach(room => {
                                room.classList.remove('disabled');
                            });
                            if (!timerInterval) {
                                timerInterval = setInterval(updateTimer, 1000);
                            }
                        } else {
                            if (timerInterval) {
                                clearInterval(timerInterval);
                                timerInterval = null;
                            }
                            if (data.timeRemaining <= 0) {
                                document.getElementById('gameOver').style.display = 'block';
                                document.querySelectorAll('.room').forEach(room => {
                                    room.classList.add('disabled');
                                });
                            }
                        }
                    }
                    
                    // Update active players
                    if (data.players) {
                        const playerCount = Object.keys(data.players).length;
                        document.getElementById('activePlayers').textContent = `üë• Active Players: ${playerCount}`;
                    }
                    
                    showSyncIndicator('üîÑ Synced');
                }
            });
            
            // Register this player
            const playerRef = ref(database, `teams/${teamId}/players/${playerId}`);
            set(playerRef, {
                name: playerName,
                joinedAt: Date.now()
            });
            
            // Remove player on disconnect
            window.addEventListener('beforeunload', () => {
                if (database && window.firebaseDB && playerId) {
                    const { ref, remove } = window.firebaseDB;
                    // Remove from team players
                    remove(playerRef);
                    // Remove from active players list
                    const playerActiveRef = ref(database, `activePlayers/${playerId}`);
                    remove(playerActiveRef);
                }
            });
            
            showSyncIndicator('‚úÖ Connected to team!');
        }

        function syncToDatabase(updates) {
            if (!database || !window.firebaseDB) {
                console.warn('Firebase not ready, skipping sync');
                return;
            }
            
            showSyncIndicator('üîÑ Syncing...');
            
            const { ref, update } = window.firebaseDB;
            const teamId = teamName.toLowerCase().replace(/\s+/g, '-');
            update(ref(database, `teams/${teamId}`), updates).then(() => {
                showSyncIndicator('‚úÖ Synced');
            }).catch((error) => {
                console.error('Sync error:', error);
                showSyncIndicator('‚ùå Sync failed');
            });
        }

        function openRoom(roomId) {
            if (!gameActive) return;
            
            currentRoom = roomId;
            document.getElementById('modalRoomTitle').textContent = roomNames[roomId];
            document.getElementById('roomModal').classList.add('active');
            
            const grid = document.getElementById('markersGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 9; i++) {
                const marker = document.createElement('div');
                marker.className = 'marker-point';
                marker.dataset.id = i;
                
                const markerData = markedLocations[roomId]?.[i];
                const count = markerData?.count || 0;
                
                // Main number (position/point identifier)
                const mainNumber = document.createElement('div');
                mainNumber.className = 'marker-main-number';
                mainNumber.textContent = count > 0 ? count : '‚Ä¢';
                marker.appendChild(mainNumber);
                
                if (count > 0) {
                    marker.classList.add('marked');
                    
                    // Counter controls
                    const counterWrapper = document.createElement('div');
                    counterWrapper.className = 'marker-counter-wrapper';
                    
                    // Minus button
                    const minusBtn = document.createElement('div');
                    minusBtn.className = 'marker-count-btn';
                    minusBtn.textContent = '‚àí';
                    minusBtn.onclick = (e) => {
                        e.stopPropagation();
                        adjustMarkerCount(roomId, i, -1);
                    };
                    
                    // Plus button
                    const plusBtn = document.createElement('div');
                    plusBtn.className = 'marker-count-btn';
                    plusBtn.textContent = '+';
                    plusBtn.onclick = (e) => {
                        e.stopPropagation();
                        adjustMarkerCount(roomId, i, 1);
                    };
                    
                    counterWrapper.appendChild(minusBtn);
                    counterWrapper.appendChild(plusBtn);
                    marker.appendChild(counterWrapper);
                    
                    // Show who marked it
                    if (markerData.playerName) {
                        const playerLabel = document.createElement('span');
                        playerLabel.className = 'marker-player';
                        playerLabel.textContent = markerData.playerName;
                        marker.appendChild(playerLabel);
                    }
                } else {
                    // Click to initialize with count of 1
                    marker.onclick = () => adjustMarkerCount(roomId, i, 1);
                }
                
                grid.appendChild(marker);
            }
            
            updateRoomCount(roomId);
        }

        function closeRoom() {
            document.getElementById('roomModal').classList.remove('active');
            currentRoom = null;
        }

        function adjustMarkerCount(roomId, markerId, delta) {
            if (!gameActive) return;
            
            // Initialize marker data if not exists
            if (!markedLocations[roomId]) markedLocations[roomId] = {};
            if (!markedLocations[roomId][markerId]) {
                markedLocations[roomId][markerId] = {
                    count: 0,
                    playerName: playerName,
                    playerId: playerId,
                    timestamp: Date.now()
                };
            }
            
            // Adjust count
            const currentCount = markedLocations[roomId][markerId].count || 0;
            const newCount = Math.max(0, currentCount + delta);
            
            if (newCount === 0) {
                // Remove marker if count reaches 0
                delete markedLocations[roomId][markerId];
            } else {
                markedLocations[roomId][markerId].count = newCount;
                markedLocations[roomId][markerId].playerName = playerName;
                markedLocations[roomId][markerId].playerId = playerId;
                markedLocations[roomId][markerId].timestamp = Date.now();
            }
            
            // Update UI counts
            updateRoomCount(roomId);
            updateRoomProgress(roomId);
            updateTotalCount();
            
            // Refresh the room display to show updated counts
            if (currentRoom === roomId) {
                openRoom(roomId);
            }
            
            // Sync to database
            syncToDatabase({ markers: markedLocations });
        }

        // Practice room state (local only, not synced)
        const practiceState = {};

        function adjustPracticeCount(pointId, delta) {
            // Initialize if not exists
            if (!practiceState[pointId]) {
                practiceState[pointId] = 0;
            }
            
            // Adjust count
            const currentCount = practiceState[pointId];
            const newCount = Math.max(0, currentCount + delta);
            practiceState[pointId] = newCount;
            
            // Update UI
            const marker = document.getElementById(`practice${pointId}`);
            if (!marker) return;
            
            // Clear existing content
            marker.innerHTML = '';
            marker.onclick = null;
            
            // Main number
            const mainNumber = document.createElement('div');
            mainNumber.className = 'marker-main-number';
            mainNumber.textContent = newCount > 0 ? newCount : '‚Ä¢';
            marker.appendChild(mainNumber);
            
            if (newCount > 0) {
                marker.classList.add('marked');
                
                // Counter controls
                const counterWrapper = document.createElement('div');
                counterWrapper.className = 'marker-counter-wrapper';
                
                // Minus button
                const minusBtn = document.createElement('div');
                minusBtn.className = 'marker-count-btn';
                minusBtn.textContent = '‚àí';
                minusBtn.onclick = (e) => {
                    e.stopPropagation();
                    adjustPracticeCount(pointId, -1);
                };
                
                // Plus button
                const plusBtn = document.createElement('div');
                plusBtn.className = 'marker-count-btn';
                plusBtn.textContent = '+';
                plusBtn.onclick = (e) => {
                    e.stopPropagation();
                    adjustPracticeCount(pointId, 1);
                };
                
                counterWrapper.appendChild(minusBtn);
                counterWrapper.appendChild(plusBtn);
                marker.appendChild(counterWrapper);
            } else {
                marker.classList.remove('marked');
                marker.onclick = () => adjustPracticeCount(pointId, 1);
            }
        }

        function resetPracticeRoom() {
            // Clear practice state
            for (let key in practiceState) {
                delete practiceState[key];
            }
            
            // Reset all practice markers
            for (let i = 1; i <= 6; i++) {
                const marker = document.getElementById(`practice${i}`);
                if (marker) {
                    marker.classList.remove('marked');
                    marker.innerHTML = '<div class="marker-main-number">‚Ä¢</div>';
                    marker.onclick = () => adjustPracticeCount(i, 1);
                }
            }
        }

        function updateRoomCount(roomId) {
            const count = Object.keys(markedLocations[roomId] || {}).length;
            document.getElementById('roomCount').textContent = count;
        }

        function updateRoomProgress(roomId) {
            const count = Object.keys(markedLocations[roomId] || {}).length;
            document.getElementById(`progress-${roomId}`).textContent = `${count}/9`;
        }

        function updateAllRoomProgress() {
            rooms.forEach(room => updateRoomProgress(room));
        }

        function updateTotalCount() {
            let total = 0;
            rooms.forEach(room => {
                total += Object.keys(markedLocations[room] || {}).length;
            });
            document.getElementById('totalCount').textContent = total;
        }

        function startGame() {
            gameActive = true;
            timeRemaining = initialTimerValue; // Use admin-set value
            bonusAdded = false;
            // No start button in this version - game auto-starts on login
            document.getElementById('gameOver').style.display = 'none';
            
            document.querySelectorAll('.room').forEach(room => {
                room.classList.remove('disabled');
            });
            
            // Clear any existing interval before creating new one
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            timerInterval = setInterval(updateTimer, 1000);
            updateTimerDisplay();
            
            syncToDatabase({
                gameActive: true,
                timeRemaining: timeRemaining,
                bonusAdded: false
            });
        }

        function updateTimer() {
            if (timeRemaining > 0) {
                timeRemaining--;
                updateTimerDisplay();
                
                // Sync timer every second to Firebase
                // This ensures refreshing players always see the current time
                syncToDatabase({ timeRemaining: timeRemaining });
            }
            
            if (timeRemaining <= 0 && !bonusAdded) {
                addBonusTime();
            } else if (timeRemaining <= 0 && bonusAdded) {
                endGame();
            }
        }

        function updateTimerDisplay() {
            // Ensure time doesn't go negative
            const safeTime = Math.max(0, timeRemaining);
            const minutes = Math.floor(safeTime / 60);
            const seconds = safeTime % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const timerElement = document.getElementById('timer');
            timerElement.textContent = display;
            
            if (timeRemaining <= 30) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.remove('warning');
            }
        }

        function addBonusTime() {
            bonusAdded = true;
            const bonusTime = window.bonusTimeValue || 30;
            timeRemaining = bonusTime;
            
            // Update surprise message with actual bonus time
            const surpriseMsg = document.getElementById('surpriseMessage');
            surpriseMsg.innerHTML = `üéâ PLOT TWIST! üéâ<br>You get ${bonusTime} MORE SECONDS!<br>It's not over yet! üòÑ`;
            
            document.getElementById('surpriseOverlay').classList.add('show');
            surpriseMsg.classList.add('show');
            
            setTimeout(() => {
                document.getElementById('surpriseOverlay').classList.remove('show');
                surpriseMsg.classList.remove('show');
            }, 3000);
            
            syncToDatabase({
                timeRemaining: timeRemaining,
                bonusAdded: true
            });
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            document.getElementById('gameOver').style.display = 'block';
            
            document.querySelectorAll('.room').forEach(room => {
                room.classList.add('disabled');
            });
            
            closeRoom();
            
            syncToDatabase({ gameActive: false });
            
            console.log('üéâ Game completed! Admin can view results on dashboard.');
        }

        function resetGame() {
            if (!confirm('This will reset the game for ALL team members. Continue?')) {
                return;
            }
            
            gameActive = false;
            clearInterval(timerInterval);
            timeRemaining = initialTimerValue; // Use admin-set value
            bonusAdded = false;
            // No start button in this version
            document.getElementById('gameOver').style.display = 'none';
            
            rooms.forEach(room => {
                markedLocations[room] = {};
                updateRoomProgress(room);
            });
            
            document.querySelectorAll('.room').forEach(room => {
                room.classList.remove('disabled');
            });
            
            updateTotalCount();
            updateTimerDisplay();
            closeRoom();
            
            syncToDatabase({
                markers: markedLocations,
                gameActive: false,
                timeRemaining: 60,
                bonusAdded: false
            });
        }

        function logout() {
            if (gameActive && !confirm('Game is in progress! Are you sure you want to leave?')) {
                return;
            }
            
            if (database && window.firebaseDB && playerId) {
                const { ref, remove } = window.firebaseDB;
                const teamId = teamName.toLowerCase().replace(/\s+/g, '-');
                // Remove from team players
                remove(ref(database, `teams/${teamId}/players/${playerId}`));
                // Remove from active players list
                const playerActiveRef = ref(database, `activePlayers/${playerId}`);
                remove(playerActiveRef);
            }
            
            // Clear sessionStorage
            sessionStorage.removeItem('playerName');
            sessionStorage.removeItem('teamName');
            sessionStorage.removeItem('playerId');
            
            location.reload();
        }

        /* 
        ==========================================
        DEPLOYMENT & USAGE
        ==========================================
        
        CURRENT STATUS: ‚úÖ Firebase Config Added!
        
        NEXT STEP: Add your databaseURL (see instructions at top)
        
        ONCE COMPLETE:
        1. Save this file as index.html
        2. Deploy to:
           - GitHub Pages (free)
           - Netlify (free)  
           - Vercel (free)
           - Or open locally in browser
        
        3. Share the URL with your team
        4. Everyone enters the SAME team name
        5. Each person enters their own player name
        6. Enter password: anvi
        7. Game starts automatically!
        8. Collaborate in real-time!
        
        HOW MULTIPLAYER WORKS:
        - All players with same team name share state
        - Marks sync instantly across all devices
        - Shared timer for the whole team (2 min + 30 sec bonus!)
        - See who marked each location
        - Active player count updates live
        - Game auto-starts when you login
        - Admin can view all team progress on dashboard
        
        TIPS:
        - Open in multiple browser tabs to test
        - Each tab = different player
        - Works across different devices/computers
        - No limit on number of players per team
        
        SECURITY:
        - Current setup: Open access (test mode)
        - Perfect for this game scenario
        - No sensitive data being stored
        - Team names act as simple room codes
        
        TROUBLESHOOTING:
        - If not connecting: Check databaseURL
        - If sync issues: Check browser console (F12)
        - If rules error: Check database rules in Firebase
        - Connection status shown at top of game screen
        
        ==========================================
        */
    </script>
</body>
</html>
